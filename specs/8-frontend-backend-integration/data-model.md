# Data Model: Frontend and Backend Integration

## Core Entities

### QueryRequest (Extended from Backend)
Represents a user's query request to be sent to the RAG backend.

**Fields**:
- `query` (string, required): The user's question or query text
- `max_results` (integer, optional, default: 5): Maximum number of context chunks to retrieve
- `similarity_threshold` (float, optional, default: 0.5): Minimum similarity score for results
- `context` (object, optional): Additional context information for the query
  - `selected_text` (string, optional): Text selected by the user on the current page
  - `current_page` (string, optional): Current page URL/path where query originated
  - `page_title` (string, optional): Title of the current page

**Validation Rules**:
- `query` must be non-empty string with 1-1000 characters
- `max_results` must be between 1-20
- `similarity_threshold` must be between 0.0-1.0
- `context.selected_text` must be non-empty when provided

**Example**:
```json
{
  "query": "What is the main concept here?",
  "max_results": 5,
  "similarity_threshold": 0.5,
  "context": {
    "selected_text": "Physical AI represents the integration of AI algorithms with physical systems...",
    "current_page": "/docs/introduction",
    "page_title": "Introduction to Physical AI"
  }
}
```

### QueryResponse (from Backend)
Represents the response from the RAG agent containing the answer and supporting information.

**Fields**:
- `query` (string, required): The original user query
- `answer` (string, required): The answer generated by the OpenAI model
- `retrieved_chunks` (array of objects, required): Context chunks retrieved from Qdrant
- `timestamp` (string, required): ISO 8601 formatted timestamp
- `sources` (array of strings, required): Unique source URLs of retrieved content

**Validation Rules**:
- `answer` must be non-empty string
- `retrieved_chunks` must contain at least 0 or more QueryResult objects
- `timestamp` must be valid ISO 8601 format
- `sources` must be array of valid URLs

### ChatMessage
Represents a single message in the chat conversation.

**Fields**:
- `id` (string, required): Unique identifier for the message
- `text` (string, required): The content of the message
- `sender` (string, required): 'user' or 'agent' indicating message origin
- `timestamp` (string, required): ISO 8601 formatted timestamp
- `sources` (array of strings, optional): Source URLs for agent responses
- `isLoading` (boolean, optional): True if this is a temporary loading message

**Validation Rules**:
- `id` must be unique within the conversation
- `sender` must be one of: 'user', 'agent'
- `text` must be non-empty when not loading
- `isLoading` can only be true for agent messages

**Example**:
```json
{
  "id": "msg-12345",
  "text": "Physical AI is a field that combines artificial intelligence with physical systems...",
  "sender": "agent",
  "timestamp": "2025-12-20T10:30:00.123456Z",
  "sources": ["https://physical-ai-book-rose.vercel.app/introduction"],
  "isLoading": false
}
```

### ChatState
Represents the current state of the chat conversation.

**Fields**:
- `messages` (array of ChatMessage, required): All messages in the conversation
- `isLoading` (boolean, required): True when waiting for agent response
- `error` (string, optional): Error message if any issues occurred
- `context` (object, optional): Current context information
  - `selectedText` (string, optional): Currently selected text on page
  - `currentPage` (string, optional): Current page URL

**Validation Rules**:
- `messages` must be properly ordered by timestamp
- `error` should be null when no errors exist
- `context` should reflect current page state

### UIConfiguration
Represents configuration options for the chat UI component.

**Fields**:
- `backendUrl` (string, required): URL of the FastAPI backend service
- `position` (string, required): Widget position ('bottom-right', 'bottom-left', etc.)
- `theme` (string, optional): Color theme ('light', 'dark', 'auto')
- `isOpen` (boolean, optional): Whether the chat widget is expanded
- `showOnAllPages` (boolean, optional): Whether to show on all pages

**Validation Rules**:
- `backendUrl` must be a valid URL format
- `position` must be one of: 'bottom-right', 'bottom-left', 'top-right', 'top-left'
- `theme` must be one of: 'light', 'dark', 'auto', or null

**Example**:
```json
{
  "backendUrl": "http://localhost:8000",
  "position": "bottom-right",
  "theme": "auto",
  "isOpen": false,
  "showOnAllPages": true
}
```

## Relationships

### QueryRequest → QueryResponse
- One-to-one relationship during API call
- Each query request generates one response
- Response contains reference to original query

### ChatState → ChatMessage
- One-to-many relationship
- Each chat state contains multiple messages
- Messages form the conversation history

### ChatMessage → QueryResponse
- One-to-one relationship for agent messages
- Agent ChatMessage contains data from QueryResponse
- User messages don't have QueryResponse relationship

## State Transitions

### Chat Message States
1. **Created**: Message object is initialized
2. **Sending**: User message is being sent to backend
3. **Loading**: Waiting for agent response (isLoading message)
4. **Received**: Agent response received and processed
5. **Rendered**: Message displayed in UI

### Chat Widget States
1. **Closed**: Widget is minimized/collapsed
2. **Opening**: Transitioning from closed to open
3. **Open**: Widget is expanded and visible
4. **Closing**: Transitioning from open to closed

## Constraints

### Data Integrity Constraints
- All user messages must be validated before sending to backend
- Agent responses must be properly attributed with sources
- Message ordering must be maintained chronologically
- Context information must be accurately captured

### Performance Constraints
- Query requests should be debounced to prevent spam
- Large responses should be paginated or truncated appropriately
- Message history should be limited to prevent memory issues
- API calls should have reasonable timeout values