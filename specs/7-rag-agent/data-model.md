# Data Model: RAG Agent with OpenAI and FastAPI

## Core Entities

### QueryRequest
Represents a user's query request to the RAG agent.

**Fields**:
- `query` (string, required): The user's question or query text
- `max_results` (integer, optional, default: 5): Maximum number of context chunks to retrieve from Qdrant
- `similarity_threshold` (float, optional, default: 0.5): Minimum similarity score for retrieved results

**Validation Rules**:
- `query` must be non-empty string with 1-1000 characters
- `max_results` must be between 1-20
- `similarity_threshold` must be between 0.0-1.0

**Example**:
```json
{
  "query": "What is Physical AI?",
  "max_results": 5,
  "similarity_threshold": 0.5
}
```

### QueryResponse
Represents the response from the RAG agent containing the answer and supporting information.

**Fields**:
- `query` (string, required): The original user query
- `answer` (string, required): The answer generated by the OpenAI model based on retrieved context
- `retrieved_chunks` (array of objects, required): Context chunks retrieved from Qdrant
- `timestamp` (string, required): ISO 8601 formatted timestamp of response generation
- `sources` (array of strings, required): Unique source URLs of retrieved content

**Validation Rules**:
- `answer` must be non-empty string
- `retrieved_chunks` must contain at least 0 or more QueryResult objects
- `timestamp` must be valid ISO 8601 format
- `sources` must be array of valid URLs

**Example**:
```json
{
  "query": "What is Physical AI?",
  "answer": "Physical AI is a field that combines artificial intelligence with physical systems...",
  "retrieved_chunks": [
    {
      "id": "chunk-id",
      "content": "Physical AI represents the integration of AI algorithms...",
      "source_url": "https://physical-ai-book-rose.vercel.app/...",
      "similarity_score": 0.85,
      "metadata": {
        "title": "Introduction to Physical AI",
        "created_at": "2025-12-19T10:30:00"
      }
    }
  ],
  "timestamp": "2025-12-19T15:30:00.123456",
  "sources": [
    "https://physical-ai-book-rose.vercel.app/introduction"
  ]
}
```

### QueryResult (Extended from existing code)
Represents a single chunk of content retrieved from Qdrant with similarity information.

**Fields**:
- `id` (string, required): Unique identifier for the Qdrant point
- `content` (string, required): The text content of the chunk
- `source_url` (string, required): URL where the content originated
- `metadata` (object, required): Additional information about the content
- `similarity_score` (float, required): Cosine similarity score (0.0-1.0)

**Validation Rules**:
- `id` must be non-empty string
- `content` must be non-empty string with minimum 10 characters
- `source_url` must be valid URL format
- `metadata` must contain required fields: 'title', 'created_at'
- `similarity_score` must be between 0.0-1.0

### HealthResponse
Represents the response from the health check endpoint.

**Fields**:
- `status` (string, required): Overall system status ("healthy", "degraded", "unhealthy")
- `timestamp` (string, required): ISO 8601 formatted timestamp
- `services` (object, required): Status of individual services

**Validation Rules**:
- `status` must be one of: "healthy", "degraded", "unhealthy"
- `timestamp` must be valid ISO 8601 format
- `services` must contain status information for critical services

**Example**:
```json
{
  "status": "healthy",
  "timestamp": "2025-12-19T15:30:00.123456",
  "services": {
    "api": "operational",
    "qdrant": "connected",
    "openai": "available"
  }
}
```

## Relationships

### QueryRequest → QueryResponse
- One-to-one relationship
- Each query request generates one response
- Response contains reference to original query

### QueryResponse → QueryResult
- One-to-many relationship
- Each response can contain multiple retrieved context chunks
- Chunks provide the context used to generate the answer

### QueryResult → Source Document
- Many-to-one relationship
- Multiple chunks can come from the same source document
- Source URL indicates the origin of the content

## State Transitions

### Query Processing States
1. **Received**: Query request has been received by the API
2. **Context Retrieval**: System is searching Qdrant for relevant context
3. **Answer Generation**: OpenAI is generating answer from context
4. **Response Formed**: Answer and metadata are prepared for response
5. **Completed**: Response has been sent back to the client

## Constraints

### Performance Constraints
- Query response time should be under 5 seconds
- Maximum 20 context chunks per query to prevent excessive API usage
- Content truncation at 1000 characters for display purposes

### Data Integrity Constraints
- All responses must be grounded in retrieved context
- "Not found in context" responses when no relevant content exists
- Minimum similarity threshold enforcement
- Proper metadata validation before response generation